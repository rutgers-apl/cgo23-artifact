#include <math.h>
#include "rlibm.h"
#include "exp2.h"

// The is Estrin's polymomial for the piecewise version of exp

double rlibm_exp_estrin(float x) {
  float_x fx;
  fx.f = x;
  
  // Take care of special cases
  if ((fx.x & 0x7FFFFFFF) == 0) return 1.0;

  if (fx.x <= 872415231) {
    if (fx.x <= 864026623) return 1.0000000298023223876953125;
    return 1.0000000894069671630859375;
  }

  if (1118925336 <= fx.x && fx.x <= 3011510272) {
    if (fx.x < 0x80000000) {
      if (fx.x < 0x7F800000) return 3.40282361850336062550457001444955389952e+38;
      if (fx.x == 0x7F800000) return 1.0 / 0.0;
      return 0.0/0.0;
    }
    
    // negative counterpart
    if (fx.x <= 3003121664) return 0.99999998509883880615234375;
    
    return 0.99999995529651641845703125;
  }

  if (fx.x >= 3268407733) {
    if (fx.x == 0xFF800000) return 0.0;
    if (fx.x < 0xFF800000) return ldexp(1.0, -151);
    return 0.0/0.0;
  }
  
  // Perform range reduction
  double xp = x * 92.332482616893656768297660164535045623779296875;
  int N = (int)xp;
  int N2 = N % 64;
  if (N2 < 0) N2 += 64;
  int N1 = N - N2;
  
  int M = N1 / 64;
  int J = N2;
  double R = x - N *
  0.01083042469624914509729318723429969395510852336883544921875;
  
  double_x dX;
  dX.d = R;
  double y;
  
  if (R < -9.64999884445205680094659328460693359375e-08) {
    if(R == -3.8539766470648828544653952121734619140625000000000000000000000000000000e-03){
        y = 9.9615344038951469940457172924652695655822753906250000000000000000000000e-01;
    } else if(R == -3.4599164115673985975263349246233701705932617187500000000000000000000000e-03){
        y = 9.9654606220206354283419614148442633450031280517578125000000000000000000e-01;
    } else if(R == -4.6210235450416803359985351562500000000000000000000000000000000000000000e-04){
        y = 9.9953797459602367059261496251565404236316680908203125000000000000000000e-01;
    } else if(R == -3.7742822314612567424774169921875000000000000000000000000000000000000000e-04){
        y = 9.9962261319160472528011496251565404236316680908203125000000000000000000e-01;
    } else if(R == -2.9176899261074140667915344238281250000000000000000000000000000000000000e-05){
        y = 9.9997079372406016961605246251565404236316680908203125000000000000000000e-01;
    } else{
        y = 1.0000000000000017763568394002504646778106689453125000000000000000000000e+00;
        y += R*9.9999999999695865504634184617316350340843200683593750000000000000000000e-01;
        y += R*R*(4.9999999477827639093874267928185872733592987060546875000000000000000000e-01 + R*1.6666494033259565687998815519677009433507919311523437500000000000000000e-01);
        y += R*R*R*R*4.1459497880740638076080273322077118791639804840087890625000000000000000e-02;
    }
  } else {
    if(R == 8.3387088168791478892671875655651092529296875000000000000000000000000000e-03){
        y = 1.0083735419018842183191964068100787699222564697265625000000000000000000e+00;
    } else if(R == 1.0653082311111313276730250265700306044891476631164550781250000000000000e-02){
        y = 1.0107100284300554182692621907335706055164337158203125000000000000000000e+00;
    } else if(R == 1.0716196084804785471078503178432583808898925781250000000000000000000000e-02){
        y = 1.0107738201671014888205490933614782989025115966796875000000000000000000e+00;
    }else{
        y = 9.9999999999999977795539507496869191527366638183593750000000000000000000e-01;
        y += R*9.9999999999762156921434552714345045387744903564453125000000000000000000e-01;
        y += R*R*(5.0000000350938178517168353209854103624820709228515625000000000000000000e-01 + R*1.6666532029001432380077574180177180096507072448730468750000000000000000e-01);
        y += R*R*R*R*4.1851631253046917002791360573610290884971618652343750000000000000000000e-02;
    }
  }
  
  // Perform output compensation
  y *= ldexp(exp2JBy64[J], M);
  return y;
}
